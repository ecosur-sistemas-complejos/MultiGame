<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" 
    xmlns:gente="mx.ecosur.multigame.gente.*"
    xmlns:manantiales="mx.ecosur.multigame.manantiales.*"
    xmlns:pasale="mx.ecosur.multigame.pasale.*"
    xmlns:component="mx.ecosur.multigame.component.*"
    layout="absolute">

    <mx:Style source="style.css"/>

    <mx:Script>
        <![CDATA[
        import mx.ecosur.multigame.entity.Registrant;
        import mx.ecosur.multigame.manantiales.entity.ManantialesGame;
        import mx.ecosur.multigame.gente.entity.GenteGame;
        import mx.ecosur.multigame.pasale.entity.PasaleGame;
        import mx.managers.CursorManager;

        import mx.ecosur.multigame.entity.Game;
        import mx.ecosur.multigame.event.PlayEvent;
        import mx.controls.Alert;
        import mx.ecosur.multigame.gente.GenteGameWindow;
        import mx.ecosur.multigame.manantiales.ManantialesWindow;
        import mx.ecosur.multigame.pasale.PasaleGameWindow;
        import mx.rpc.events.FaultEvent;
        import mx.rpc.events.ResultEvent;

        private var _genteGameWindow:GenteGameWindow,
                _manantialesWindow:ManantialesWindow,
                _pasaleWindow:PasaleGameWindow;

        private function init():void {
            loginPrincipal();
        }

        private function gameComplete(event:Event):void {
            lobby.reload(event);
            vstack.selectedChild = lobby;

            /* Clear out any running games */
            if (_genteGameWindow != null) {
                _genteGameWindow.destroy();
                vstack.removeChild(_genteGameWindow);
                _genteGameWindow = null;
            }

            if (_manantialesWindow != null) {
                _manantialesWindow.destroy();
                vstack.removeChild(_manantialesWindow);
                _manantialesWindow = null;
            }

            if (_pasaleWindow == null) {
                _pasaleWindow.destroy();
                vstack.removeChild(_pasaleWindow);
                _pasaleWindow = null;
            }

            /* Restart the lobby timer to view any updates to
             * system state ... */
            lobby.timer.start();
            lobby.setFocus();
        }

        private function loginPrincipal():void {
            gameService.registerPrincipal();
        }

        private function resultHandler(event:ResultEvent):void {
            if (event.result is Registrant) {
                lobby.player = Registrant(event.result);
            } else
                Alert.show("Unable to interpret event: " + event);
        }

        private function faultHandler(event:FaultEvent):void {
            Alert.show(event.fault.faultString, "Error!");
        }

        private function lobbyDone(event:PlayEvent):void {
            lobby.timer.stop();
            if (event.game is GenteGame) {
                //create new pente game window
                _genteGameWindow = new GenteGameWindow();
                _genteGameWindow.currentPlayer = event.gamePlayer;
                _genteGameWindow.currentGame = GenteGame(event.game);
                _genteGameWindow.rows = event.game.rows;
                _genteGameWindow.columns = event.game.columns;
                _genteGameWindow.addEventListener("complete", gameComplete);
                vstack.addChild(_genteGameWindow);
                vstack.selectedChild = _genteGameWindow;
            } else if (event.game is ManantialesGame) {
                _manantialesWindow = new ManantialesWindow();
                _manantialesWindow.currentPlayer = event.gamePlayer;
                _manantialesWindow.currentGame = ManantialesGame(event.game);
                _manantialesWindow.addEventListener("complete", gameComplete);
                vstack.addChild(_manantialesWindow);
                vstack.selectedChild = _manantialesWindow;
            } else if (event.game is PasaleGame) {
                _pasaleWindow = new PasaleGameWindow();
                _pasaleWindow.currentPlayer = event.gamePlayer;
                _pasaleWindow.currentGame = PasaleGame(event.game);
                _pasaleWindow.addEventListener("complete", gameComplete);
                vstack.addChild(_pasaleWindow);
                vstack.selectedChild = _pasaleWindow;
            } else {
                var game:Game = event.game;
                Alert.show("Error!  Unknown GameType [" + game + "]");
                Alert.show("Game info" + game.id + "," + game.columns + ", " + game.rows);
                CursorManager.removeBusyCursor();
            }
        }
        ]]>
    </mx:Script>
    <mx:RemoteObject id="gameService" destination="gameService" result="resultHandler(event)" fault="faultHandler(event)"/>
    <mx:ViewStack id="vstack" width="100%" height="100%" verticalCenter="0">
        <component:Lobby id="lobby" creationComplete="init()" registered="lobbyDone(event)"
             gameChosen="lobbyDone(event)" gameJoined="lobbyDone(event)" />
        <gente:GenteGameWindow id="genteGameWindow" complete="gameComplete(event)" />
        <manantiales:ManantialesWindow id="manantialesWindow" complete="gameComplete(event)" />
        <pasale:PasaleGameWindow id="pasaleWindow" complete="gameComplete(event)" />
	</mx:ViewStack>
</mx:Application>
